<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Article</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'article2.css' %}">
</head>
<body>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
          <img src="/docs/4.1/assets/brand/bootstrap-solid.svg" width="30" height="30" class="d-inline-block align-top" alt="">
         Sarva samachar
        </a>
      </nav>
    <div class="row header d-flex justify-content-around headercon" style="overflow-x: auto; white-space: nowrap;">
        <div class="d-flex justify-content-start">
            <!-- <h5 class="headritem" id="dateHeading">11th Oct</h5> -->
            <h5 class="headritem" id="overallTab"><a href="{% url 'home'  %}">Home</a></h5>
            <h5 class="headritem" id="Political"><a href="{% url 'category'  'Political' %}">Political</a></h5>
            <h5 class="headritem" id="Film"><a href="{% url 'category'  'Film' %}">Film</a></h5>
            <h5 class="headritem" id="International"><a href="{% url 'category'  'International' %}">International</a></h5>
        </div>
    </div>
    
    <div class="container">
        <div class="heading d-flex justify-content-between articleT"><span class="articleT">{{article.title}}</span> <i class="bi bi-share" id="shareBtn"></i></div>

        <div class="voting-bar-container">
            <div class="d-flex justify-content-center"> <span>Total Votes:</span><span id="total_votes">  0</span></div>
            <div class="voting-bar">
                <div id="inner-bar1"></div>
            </div>
            <div class="votes">
                {% for view in views %}
                <div> <span>{{view.view_name}}</span><span id="{{ view.view_id  }}"> Votes: 0</span></div>
                 {% endfor %}
                
            </div>
           
        </div>

        <div class="tabs">
            {% for view in views %}
            {% if forloop.counter == 1 %}
            <div class="tab active" data-tab="{{view.view_id}}">{{view.view_name}}</div>
            {% else %}
            <div class="tab " data-tab="{{view.view_id}}">{{view.view_name}}</div>
            {% endif %}
            {% endfor %}
        </div>

        {% for view in views %}

        {% if forloop.counter == 1 %}
        <div class="tab-content active" id="{{view.view_id}}"  >
        {% else %}
        <div class="tab-content" id="{{view.view_id}}"  >
        {% endif %}

        <button type="button" class="btn btn-outline-dark" onclick="vote('{{view.view_id}}','{{article.article_id}}' )">నేను దీన్ని మద్దతు ఇస్తున్నాను</button>
            
            <h3 class="articleT" >{{view.view_heading}}</h3>
            <img src="{{ article.headline_image.url }}" alt="News Image" width="200">

            <p class="trendDes">
                {{view.content|safe}}
                 
            </p>
           </div>
           {% endfor %}

        
    </div>

    <script>
        let votes={};
        votes['totalvotes']=0;
        {% for view in views %}
        votes["{{ view.view_id }}"] = 0;
    {% endfor %}
        const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
fetchResults({{article.article_id}});

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const target = tab.getAttribute('data-tab');
        tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === target) {
                content.classList.add('active');
            }
        });
    });
});

function vote(side,article_id) {
    fetch('/vote/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
             // Include CSRF token if CSRF protection is enabled
        },
        body: JSON.stringify({ 'option_id': side,'article_id':article_id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the local votes and fetch the updated results
           // votes[side]++;
            //votes['totalvotes']++;
            //updateVotes();
            fetchResults({{article.article_id}})
        } else {
            console.error(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
console.log(side)


//votes['totalvotes']+=1;
  //  updateVotes();
}

function updateVotes() {
   
    {% for view in views %}
    {% if forloop.counter == 1 %}
     one=votes["{{ view.view_id }}"];
     {% endif %}
        document.getElementById("{{ view.view_id }}").textContent = `{{view.view_name}} Votes: ${votes["{{ view.view_id }}"]}`;
        
        
    {% endfor %}
    
   
    console.log(votes);
    
    //console.log(one);
    //console.log(votes['totalvotes'])
    const leftPercentage = (one / votes['totalvotes']) * 100;
    //console.log(leftPercentage);
    document.getElementById('inner-bar1').style.width = `${leftPercentage}%`;
}
let one=0;
function fetchResults(pollId) {
    fetch(`/poll/${pollId}/results/`)
    .then(response => response.json())
    .then(data => {
        // Handle the results update (this is just an example)
        console.log(data);
        if (data.total_votes) {
            let i=0;
            Object.keys(data).forEach(key => {
                
                if (key !== 'total_votes') {
                    if(i==0){
                       one=data[key]
                }
                i++;
                    document.getElementById(`${key}`).textContent = ` : ${((data[key]/ data['total_votes'])*100).toFixed(2)}%`;
                }
            }
            
        );
            // Update the bar width based on 
            document.getElementById("total_votes").textContent = `${data["total_votes"]}`;
            const leftPercentage = (one / data['total_votes']) * 100; // Example for one option
            document.getElementById('inner-bar1').style.width = `${leftPercentage}%`;
        }
    })
    .catch(error => console.error('Error fetching results:', error));
}

       
       function openNav() {
  document.getElementById("mySidepanel").style.width = "250px";
}

/* Set the width of the sidebar to 0 (hide it) */
function closeNav() {
  document.getElementById("mySidepanel").style.width = "0";
}
document.querySelector('#shareBtn')
        .addEventListener('click', event => {

            // Fallback, Tries to use API only
            // if navigator.share function is
            // available
            if (navigator.share) {
                navigator.share({

                    // Title that occurs over
                    // web share dialog
                    title:  '{{article.title}}',

                    // URL to share
                    url:'http://127.0.0.1:8000/article/'+'{{article.slug}}'
                }).then(() => {
                    
                }).catch(err => {

                    // Handle errors, if occurred
                    console.log(
                    "Error while using Web share API:");
                    console.log(err);
                });
            } else {

                // Alerts user if API not available 
                alert("Browser doesn't support this API !");
            }
        })
        const today = new Date();

// Format the date to '11th Oct' format
const options = { day: 'numeric', month: 'long'  };
const formattedDate = today.toLocaleDateString('en-US', options);

// Add the date suffix (st, nd, rd, th)
function getDayWithSuffix(date) {
    const day = date.getDate();
    if (day > 3 && day < 21) return day + 'th'; // Exceptions for 11th to 13th
    switch (day % 10) {
        case 1: return day + 'st';
        case 2: return day + 'nd';
        case 3: return day + 'rd';
        default: return day + 'th';
    }
}

// Apply the suffix to the day
const dayWithSuffix = getDayWithSuffix(today);

console.log("running")
document.getElementById('dateHeading').textContent = dayWithSuffix + ', ' + formattedDate.split(' ')[0];
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
